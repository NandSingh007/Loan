<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Page</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4; /* Light gray background */
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #f9f9f9; /* Default background color */
        transition: background-color 0.3s ease; /* Smooth transition for color change */
    }
    .header.active {
        background-color: #d4edda; /* Light green color for active status */
    }
    .header.inactive {
        background-color: #f8d7da; /* Light red color for inactive status */
    }
    .loan-amount {
        color: #333;
    }
    .statusIcon i {
        font-size: 24px;
    }
    .statusIcon i.active {
        color: #00FF00; /* Green color for active */
    }
    .statusIcon i.inactive {
        color: #FF0000; /* Red color for inactive */
    }
    .loan-amount {
        background-color: #ffc107; /* Amber color for the loan amount */
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 1rem;
        font-weight: bold;
        color: #000;
        display: inline-flex;
        align-items: center;
        border: 2px solid #000;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
        .loan-amount {
            background-color: #ffc107; /* Amber color for the loan amount */
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 1rem;
            font-weight: bold;
            color: #000;
            display: inline-flex;
            align-items: center;
            border: 2px solid #000;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .separator {
            display: inline-block;
            margin: 0 5px;
            font-size: 1.2rem;
            color: #000;
        }

        .application-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .form-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 700;
            color: #00796b; /* Teal color for the header text */
        }

        .company-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .detail-section {
            flex: 1;
            text-align: center;
            font-size: 1rem;
            padding: 10px;
            background-color: #e0f2f1; /* Light teal background for details */
            border: 1px solid #00796b; /* Teal border for details */
            border-radius: 8px;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #00796b; /* Teal color for titles */
        }

        .info-text {
            font-size: 0.9rem;
            color: #333;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .info-table th,
        .info-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        .info-table th {
            background-color: #00796b; /* Teal color for table header */
            color: #fff;
            font-weight: bold;
        }

        .note-section {
            margin-top: 20px;
        }

        .note {
            font-size: 0.9rem;
            color: #333;
        }

        .note-highlight {
            font-weight: bold;
            color: #d32f2f; /* Red color for highlighted text */
        }

        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .signature {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .signature-text {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #333;
        }

        .contact-info {
            text-align: center;
            font-size: 0.9rem;
            color: #333;
            margin-top: 20px;
        }

        .download-button {
            margin-top: 20px;
            font-size: 1rem;
            color: #fff;
            cursor: pointer;
            background: #00796b; /* Teal color for the button */
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .instruction-text {
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
            color: #d32f2f; /* Red color for instructions */
            padding: 15px;
            background-color: #fff;
            border: 1px solid #d32f2f;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .scanner-image-container {
            text-align: center;
            margin-top: 20px;
        }

        .scanner-image {
            width: 200px;
            height: 200px;
            background-color: #e0e0e0; /* Light gray background for image */
            border: 1px solid #bdbdbd; /* Gray border for image */
            border-radius: 8px;
        }

        .transaction-text {
            text-align: center;
            font-size: 1rem;
            color: #00796b; /* Teal color for transaction text */
            margin-top: 20px;
        }
        /* .download-button.disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
          */
        @media (max-width: 600px) {
            .header {
                font-size: 0.9rem;
            }

            .loan-amount {
                font-size: 0.8rem;
            }

            .form-header {
                font-size: 1.5rem;
            }

            .info-title {
                font-size: 0.9rem;
            }

            .info-text {
                font-size: 0.8rem;
            }
 
         
            .instruction-text {
                font-size: 0.9rem;
                padding: 10px 15px;
            }

            .scanner-image {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Status Update</h1>
        <div class="header">
            <span id="statusIcon" class="statusIcon">
                <i class="fa fa-check-circle" aria-hidden="true"></i>
                <span id="statusText">Inactive</span>
            </span>
            <span class="loan-amount" id="loanSummary">
                <!-- This will be dynamically updated -->
            </span>
        </div>
    
        <!-- Application Form Section -->
        <div class="application-form" id="pdfpage">
            <h2 class="form-header">Application Form</h2>
    
            <!-- Company Details -->
            <div class="company-details">
                <div class="detail-section" id="companyName">
                   QuickLoan
                </div>
                <div class="detail-section">
                    <img  src="/assets/img/scanner.png" alt="Company Logo" id="companyLogo" width="50" height="20">
                </div>
            </div>
    
            <!-- Personal Details -->
            <div class="info-section">
                <div class="info-title">UserName</div>
                <div class="info-text" id="userName">N/A</div>
    
                <div class="info-title">Loan Amount</div>
                <div class="info-text" id="loanAmount">$0</div>
    
                <div class="info-title">Address</div>
                <div class="info-text" id="address">N/A</div>
    
                <div class="info-title">Work</div>
                <div class="info-text" id="work">N/A</div>
    
                <div class="info-title">Income</div>
                <div class="info-text" id="income">$0</div>
    
                <div class="info-title">Loan Type</div>
                <div class="info-text" id="loanType">N/A</div>
    
               
                <div class="info-title">Interest</div>
                <div class="info-text" id="interest">0%</div>
                <div class="info-title">Duration</div>
                <div class="info-text" id="duration">N/A</div>
    
                <div class="info-title">Monthly EMI</div>
                <div class="info-text" id="monthlyEmi">$0</div>
            </div>
    
            <table class="info-table">
                <thead>
                    <tr>
                        <th>Sr.</th>
                        <th>Job</th>
                        <th>Income</th>
                    </tr>
                </thead>
                <tbody id="infoTable">
                   <tr>
                    <td>1</td>
                    <td id="job"></td>
                    <td id="inc"></td>
                   </tr>
                </tbody>
                <thead>
                    <tr>
                        <th>Sr.</th>
                        <th>Loan</th>
                        <th>Emi</th>
                    </tr>
                </thead>
                <tbody id="infoTable">
                    <tr>
                        <td>1</td>
                        <td id="loan"></td>
                        <td id="mn"></td>
                       </tr>
                </tbody>
            </table>
           
            <div class="signature-section">
                <div class="signature" id="signature1">
                    <!-- Signature will be populated dynamically -->
                </div>
                <div class="signature" id="signature2">
                    <!-- Signature will be populated dynamically -->
                </div>
            </div>
    
            <!-- Contact Information -->
            <div class="contact-info">
                <div>For more details, contact us at:</div>
                <div id="contactNo">N/A</div>
                <div id="contactEmail">N/A</div>
            </div>
            
            <button class="download-button" id="downloadButton" onclick="downloadPDF()" disabled>Download</button>
    
        </div>
    
        <!-- Instruction Text -->
        <div class="instruction-text">
            <strong>Important:</strong> Please make sure to read the instructions carefully before proceeding. If you have any questions, do not hesitate to contact us.
        </div>
    
        <!-- Scanner Image -->
        <div class="scanner-image-container">
            <img id="scannerImage" src="/assets/img/scanner.png" alt="Scanner" class="scanner-image">
        </div>
    
        <!-- Transaction Text -->
        <div class="transaction-text">
            Transaction successful. Thank you for using our service.
        </div>
    </div>
    
    <script>
function decodeJWT(token) {
    // Split the token into parts
    const parts = token.split('.');
    
    // Ensure there are 3 parts
    if (parts.length !== 3) {
        throw new Error('Invalid token');
    }
    
    // Decode the payload (base64Url)
    const payload = parts[1];
    const decodedPayload = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
    
    // Parse the JSON payload
    return JSON.parse(decodedPayload);
}

async function fetchUserDetails() {
   // Retrieve token and decode it to get userId
   const token = localStorage.getItem('tokenData');
    if (!token) {
        alert('Token is missing. Please login again.');
        return;
    }

    try {
        const tokenData = decodeJWT(token);
        const userId = tokenData.user.id; 
        if (!userId) {
            throw new Error("User ID not found");
        }
        console.log(userId, "userId");
        const response = await fetch(`https://quicklone.com/back/FetchPersonalUserdetails/${userId}`);
        console.log(response, "response");
        const data = await response.json();

        if (response.ok) {
            console.log(data.loanTypeDetails.loanType, "data.loanTypeDetails.loanType ");
            // Update UI with user data
            document.getElementById('userName').textContent = data.name || 'Joy';
            document.getElementById('loanAmount').textContent = `$${data.loanAmount || '0'}`;
            document.getElementById('address').textContent = data.address || 'N/A';
            document.getElementById('work').textContent = data.jobType || 'N/A';
            document.getElementById('income').textContent = `${data.income || '0'}`;
            document.getElementById('loanType').textContent = data.loanTypeDetails ? data.loanTypeDetails.loanType || 'N/A' : 'N/A';
        
            document.getElementById('interest').textContent = data.loanTypeDetails ? `${data.loanTypeDetails.interest || '0'}%` : '0%';
            document.getElementById('duration').textContent = `${data.duration || 'N/A'} Year`;
            document.getElementById('job').textContent = `${data.jobType || 'N/A'} Year`;
            document.getElementById('inc').textContent = `${data.income || 'N/A'} `;
            document.getElementById('loan').textContent = `${data.loanAmount || 'N/A'} `;
         
            // Calculate EMI
            const loanAmount = data.loanAmount || 0;
            const annualInterestRate = data.loanTypeDetails ? data.loanTypeDetails.interest || 0 : 0;
            const durationInYears = data.duration || 0;

            // Convert annual interest rate to monthly and duration to months
            const monthlyInterestRate = (annualInterestRate / 100) / 12;
            const numberOfPayments = durationInYears * 12;

            // EMI Calculation
            const emi = loanAmount * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments) / (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);
            document.getElementById('monthlyEmi').textContent = `${emi.toFixed(2)}`;
            document.getElementById('mn').textContent = `${emi.toFixed(2)}`;

        } else {
            console.error('Failed to fetch user details:', data.message || 'Unknown error');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

async function fetchCompanyProfile() {
    try {
        const response = await fetch('https://quicklone.com/back/fetchCompanyProfile');
        const data = await response.json();

        if (response.ok && data.success) {
            const companyData = data.data;
            console.log(companyData, "companydata");

            // Update the loan summary
            updateLoanSummary(companyData);

            // Update company details
            const contactNoElement = document.getElementById('contactNo');
            const contactEmailElement = document.getElementById('contactEmail');
            
            const scannerImage = document.getElementById('scannerImage');
            const logo = document.getElementById('companyLogo');

            if (logo) {
                if (companyData.logo) {
                    logo.src = `data:image/png;base64,${companyData.logo}`;
                } else {
                    // Fallback image if the logo is not available
                    logo.src = '/assets/img/logo.png';
                }
            } else {
                console.error('Element with ID "logo" not found');
            }

            if (scannerImage) {
                if (companyData.paymentQRCharges2) {
                    scannerImage.src = `data:image/png;base64,${companyData.paymentQRCharges2}`;
                } else {
                    // Fallback image if the QR code is not available
                    scannerImage.src = '/assets/img/scanner.png';
                }
            } else {
                console.error('Element with ID "scannerImage" not found');
            }

            if (contactNoElement && contactEmailElement) {
                contactNoElement.textContent = companyData.contactNo || 'N/A';
                contactEmailElement.textContent = companyData.email || 'N/A';
            } else {
                console.error('Elements with IDs "contactNo" or "contactEmail" not found');
            }

            // Additional data
            document.getElementById('charges1').textContent = `Charges 1: ${companyData.charges1 || 'N/A'}`;
            document.getElementById('charges2').textContent = `Charges 2: ${companyData.charges2 || 'N/A'}`;
            document.getElementById('paymentQRCharges2').textContent = `Payment QR Charges 2: $${companyData.paymentQRCharges2 || 'N/A'}`;

        } else {
            console.error('Failed to fetch company profile:', data.message || 'Unknown error');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function updateLoanSummary(data) {
    const loanSummary = document.getElementById('loanSummary');
    const charges1 = data.charges1 || 0;
    const charges2 = data.charges2 || 0;
    const total = charges1 + charges2;
    loanSummary.innerHTML = `
        <p>${charges1}</p> +
        <p>${charges2} </p> =
        <p>${total}</p>
    `;
}async function fetchData(userId) {
    try {
        const response = await fetch(`https://quicklone.com/back/checkStatatSecurity/${userId}`);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const data = await response.json();
        console.log(data.Status, "API Status"); // Debugging line
        updateStatus(data);
        downStatus(data);
    } catch (error) {
        console.error('There was a problem with the fetch operation:', error);
        updateStatus({ status: 0 }); // Assuming 0 means inactive
    }
}
function downStatus(data) {
            const downloadButton = document.getElementById('downloadButton');
            console.log(downloadButton, "downloadButton element");
            console.log(data, "data object");

            if (downloadButton) {
                if (data.Status) {
                    downloadButton.disabled = false;
                    console.log("Download button enabled");
                } else {
                    downloadButton.disabled = true;
                    console.log("Download button disabled");
                }
            } else {
                console.error("Download button element not found");
            }
        }

function updateStatus(data) {
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    const header = document.querySelector('.header');
    const downloadButton = document.querySelector('.download-button');

    if (!statusIcon || !statusText || !header || !downloadButton) {
        console.error('One or more DOM elements are missing');
        return;
    }

    // Assuming data.Status contains the status
    const isActive = data.Status === 1; // Adjust based on your actual API response

    statusIcon.querySelector('i').classList.remove('active', 'inactive');
    header.classList.remove('active', 'inactive');

    if (isActive) {
        statusIcon.querySelector('i').classList.add('active');
        statusText.textContent = 'Active';
        header.classList.add('active');
        downloadButton.classList.remove('disabled');
        downloadButton.disabled = false;
    } else {
        statusIcon.querySelector('i').classList.add('inactive');
        statusText.textContent = 'Inactive';
        header.classList.add('inactive');
        downloadButton.classList.add('disabled');
        downloadButton.disabled = true;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('tokenData');
    if (!token) {
        alert('Token is missing. Please login again.');
        return;
    }

    const tokenData = decodeJWT(token);
    const userId = tokenData.user.id;
    console.log("User ID:", userId); // Debugging line

    // Fetch data immediately
    fetchData(userId);
    fetchCompanyProfile(); // Assuming this is defined elsewhere
    fetchUserDetails(); // Assuming this is defined elsewhere

    // Set interval to fetch data every 5 seconds
    setInterval(() => fetchData(userId), 5000);
});

function downloadPDF() {
    const element = document.getElementById('pdfpage');
    const options = {
        margin: 0.5,
        filename: 'application-form.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    html2pdf().set(options).from(element).save();
}

document.addEventListener('DOMContentLoaded', () => {
    const downloadButton = document.getElementById('downloadButton');
    if (downloadButton) {
        downloadButton.addEventListener('click', downloadPDF);
    }
});


</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

</body>
</html>
