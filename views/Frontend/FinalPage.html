<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Page</title>
    <link rel="stylesheet" href="styles.css">
    <style>
         body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #f9f9f9; 
        transition: background-color 0.3s ease;
    }
    .header.active {
        background-color: #d4edda; 
    }
    .header.inactive {
        background-color: #f8d7da; 
    }
    .loan-amount {
        color: #333;
    }
    .statusIcon i {
        font-size: 24px;
    }
    .statusIcon i.active {
        color: #00FF00; 
    }
    .statusIcon i.inactive {
        color: #FF0000; 
    }
    .loan-amount {
        background-color: #ffc107; 
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 1rem;
        font-weight: bold;
        color: #000;
        display: inline-flex;
        align-items: center;
        border: 2px solid #000;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    } 
         .loan-amount {
            background-color: #ffc107; 
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 1rem;
            font-weight: bold;
            color: #000;
            display: inline-flex;
            align-items: center;
            border: 2px solid #000;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .separator {
            display: inline-block;
            margin: 0 5px;
            font-size: 1.2rem;
            color: #000;
        }

        .application-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .form-header {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 700;
            color: #00796b; 
        } 

         .company-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .detail-section {
            flex: 1;
            text-align: center;
            font-size: 1rem;
            padding: 10px;
            background-color: #e0f2f1; 
            border: 1px solid #00796b; 
            border-radius: 8px; 
         }

        .info-section {
            margin-bottom: 20px;
        }

        .info-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #00796b; 
        } 

         .info-text {
            font-size: 0.9rem;
            color: #333;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .info-table th,
        .info-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        } 

         .info-table th {
            background-color: #00796b; 
            color: #fff;
            font-weight: bold;
        }

        .note-section {
            margin-top: 20px;
        }

        .note {
            font-size: 0.9rem;
            color: #333;
        }

        .note-highlight {
            font-weight: bold;
            color: #d32f2f; 
        } 

         .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .signature {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .signature-text {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #333;
        }

        .contact-info {
            text-align: center;
            font-size: 0.9rem;
            color: #333;
            margin-top: 20px;
        } 

        .download-button {
            margin-top: 20px;
            font-size: 1rem;
            color: #fff;
            cursor: pointer;
            background: #00796b; 
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: block;
            margin-left: auto;
            margin-right: auto;
        } 

        .instruction-text {
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
            color: #d32f2f; 
            padding: 15px;
            background-color: #fff;
            border: 1px solid #d32f2f;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .scanner-image-container {
            text-align: center;
            margin-top: 20px;
        } 

          .scanner-image {
            width: 200px;
            height: 200px;
            background-color: #e0e0e0; 
            border: 1px solid #bdbdbd; 
            border-radius: 8px;
        }

        .transaction-text {
            text-align: center;
            font-size: 1rem;
            color: #00796b;
            margin-top: 20px;
        } 
         .download-button.disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
          
         @media (max-width: 600px) {
            .header {
                font-size: 0.9rem;
            }

            .loan-amount {
                font-size: 0.8rem;
            }

            .form-header {
                font-size: 1.5rem;
            }

            .info-title {
                font-size: 0.9rem;
            }

            .info-text {
                font-size: 0.8rem;
            }
 
         
            .instruction-text {
                font-size: 0.9rem;
                padding: 10px 15px;
            }

            .scanner-image {
                width: 150px;
                height: 150px;
            }
        } 
 

    </style>
</head>
<body>
    <div class="container">
        <h1>Status Update</h1>
        <div class="header">
            <span id="statusIcon" class="statusIcon">
                <i class="fa fa-check-circle" aria-hidden="true"></i>
                <span id="statusText">Inactive</span>
            </span>
            <span class="loan-amount" id="loanSummary">
               
        </div>
    
        <div class="application-form" id="pdfpage">
            <h2 class="form-header">Application Form</h2>
    
            <div class="company-details">
                <div class="detail-section" id="companyName">
                    <strong>Company:</strong> QuickLoan
                </div>
                <div class="detail-section">
                    <img src="/assets/img/company-logo.png" alt="Company Logo" id="companyLogo" width="150" height="60">
                </div>
            </div>
    
            <div class="info-section">
                <div class="info-title">User Name</div>
                <div class="info-text" id="userName">N/A</div>
    
                <div class="info-title">Loan Limit</div>
                <div class="info-text" id="loanAmount">$0</div>
    
                <div class="info-title">Address</div>
                <div class="info-text" id="address">N/A</div>
    
                <div class="info-title">Job</div>
                <div class="info-text" id="work">N/A</div>
    
                <div class="info-title">Income</div>
                <div class="info-text" id="income">$0</div>
    
                <div class="info-title">Loan Type</div>
                <div class="info-text" id="loanType">N/A</div>
    
                <div class="info-title">Interest Rate</div>
                <div class="info-text" id="interest">0%</div>
    
                <div class="info-title">Duration</div>
                <div class="info-text" id="duration">N/A</div>
    
                <div class="info-title">Monthly EMI</div>
                <div class="info-text" id="monthlyEmi">$0</div>
            </div>
    
            <table class="info-table">
                <thead>
                    <tr>
                        <th>Sr.</th>
                        <th>Job Title</th>
                        <th>Monthly Income</th>
                    </tr>
                </thead>
                <tbody id="infoTableJobs">
                    <tr>
                        <td>1</td>
                        <td id="job">N/A</td>
                        <td id="inc">$0</td>
                    </tr>
                </tbody>
                <thead>
                    <tr>
                        <th>Sr.</th>
                        <th>Loan Type</th>
                        <th>Monthly EMI</th>
                    </tr>
                </thead>
                <tbody id="infoTableLoans">
                    <tr>
                        <td>1</td>
                        <td id="loan">N/A</td>
                        <td id="mn">$0</td>
                    </tr>
                </tbody>
            </table>
    
            <div class="signature-section">
                <div class="signature" id="signature1">
                    <p><strong>Authorized Signature:</strong></p>
                    <div class="signature-box"></div>
                </div>
            </div>
    
            <div class="contact-info">
                <div><strong>For further assistance, contact us at:</strong></div>
                <div id="contactNo">N/A</div>
                <div id="contactEmail">N/A</div>
            </div>
    
            <button class="download-button" id="downloadButton" onclick="downloadPDF()" disabled>Download PDF</button>
        </div>
    
        <div class="instruction-text">
            <strong>Important:</strong> Please review all the details thoroughly before proceeding. Should you have any queries or require assistance, feel free to reach out to our support team.
        </div>
    
        <div class="scanner-image-container">
            <img id="scannerImage" src="/assets/img/scanner.png" alt="Scanner" class="scanner-image">
        </div>
    
        <div class="transaction-text">
            <strong>Transaction Successful:</strong> Thank you for choosing QuickLoan. Your application has been processed successfully. We appreciate your trust in our services.
        </div>
        
        <div class="download-notes">
            <h3>Notes:</h3>
            <ul>
                <li>Please ensure that all the details in the PDF are correct before downloading.</li>
                <li>If you need to make any changes, contact our customer support for assistance.</li>
                <li>The download button will be enabled once all required fields are completed.</li>
                <li>Keep a copy of the downloaded PDF for your records and future reference.</li>
                <li>For any issues related to the download or the application, please reach out to us at <strong>support@quickloan.com</strong>.</li>
            </ul>
        </div>
    </div>
    
    
    <script>
          let tot
function decodeJWT(token) {
    // Split the token into parts
    const parts = token.split('.');
    
    // Ensure there are 3 parts
    if (parts.length !== 3) {
        throw new Error('Invalid token');
    }
    
    // Decode the payload (base64Url)
    const payload = parts[1];
    const decodedPayload = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
    
    // Parse the JSON payload
    return JSON.parse(decodedPayload);
}

async function fetchUserDetails() {
    // Retrieve token and decode it to get userId
    const token = localStorage.getItem('tokenData');
    if (!token) {
        alert('Token is missing. Please login again.');
        return;
    }

    try {
        const tokenData = decodeJWT(token);
        const userId = tokenData.user.id; 
        if (!userId) {
            throw new Error("User ID not found");
        }

        const response = await fetch(`https://quicklone.com/back/FetchPersonalUserdetails/${userId}`);
        const data = await response.json();

        if (response.ok) {
            console.log(data.loanTypeDetails.loanType, "data.loanTypeDetails.loanType ");

            // Update UI with user data
            document.getElementById('userName').textContent = data.name || 'Joy';
            document.getElementById('address').textContent = data.address || 'N/A';
            document.getElementById('work').textContent = data.jobType || 'N/A';
            document.getElementById('income').textContent = `${data.income || '0'}`;
            document.getElementById('loanType').textContent = data.loanTypeDetails ? data.loanTypeDetails.loanType || 'N/A' : 'N/A';
            document.getElementById('interest').textContent = data.loanTypeDetails ? `${data.loanTypeDetails.interest || '0'}%` : '0%';
            document.getElementById('duration').textContent = `${data.duration || 'N/A'} Year`;
            document.getElementById('job').textContent = `${data.jobType || 'N/A'} Year`;
            document.getElementById('inc').textContent = `${data.income || 'N/A'} `;
            document.getElementById('loan').textContent = data.loanTypeDetails ? `${data.loanTypeDetails.limit || '0'}` : '0';
         
            // Calculate EMI
            const loanAmount = data.loanTypeDetails ? data.loanTypeDetails.limit || 0 : 0;
            const annualInterestRate = data.loanTypeDetails ? data.loanTypeDetails.interest || 0 : 0;
            const durationInYears = data.duration || 0;

            const monthlyInterestRate = (annualInterestRate / 100) / 12;
            const numberOfPayments = durationInYears * 12;

            const emi = loanAmount * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments) / (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);
            document.getElementById('monthlyEmi').textContent = `${emi.toFixed(2)}`;
            document.getElementById('mn').textContent = `${emi.toFixed(2)}`;

            // Update loan summary
            const charges1 = data.charges1 || 0;
            const charges2 = data.charges2 || 0;
            const limit = data.loanTypeDetails ? data.loanTypeDetails.limit || 0 : 0;

            const total = charges1 + charges2 + limit;
            document.getElementById('loanSummary').innerHTML = `
                <p> ${charges1}</p>
                <p> + ${charges2}</p>
                <p>+ ${limit}</p>
                <p>= ${total}</p>
            `;

        } else {
            console.error('Failed to fetch user details:', data.message || 'Unknown error');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
async function fetchCompanyProfile() {
    try {
        const response = await fetch('https://quicklone.com/back/fetchCompanyProfile');
        const data = await response.json();

        if (response.ok && data.success) {
            const companyData = data.data;
            // console.log(companyData, "companydata");
            // Update the loan summary
            // Update company details
            const contactNoElement = document.getElementById('contactNo');
            const contactEmailElement = document.getElementById('contactEmail');
            
            const scannerImage = document.getElementById('scannerImage');
            const logo = document.getElementById('companyLogo');

            if (logo) {
                if (companyData.logo) {
                    logo.src = `data:image/png;base64,${companyData.logo}`;
                } else {
                    // Fallback image if the logo is not available
                    logo.src = '/assets/img/logo.png';
                }
            } else {
                console.error('Element with ID "logo" not found');
            }

            if (scannerImage) {
                if (companyData.paymentQRCharges2) {
                    scannerImage.src = `data:image/png;base64,${companyData.paymentQRCharges2}`;
                } else {
                    // Fallback image if the QR code is not available
                    scannerImage.src = '/assets/img/scanner.png';
                }
            } else {
                console.error('Element with ID "scannerImage" not found');
            }

            if (contactNoElement && contactEmailElement) {
                contactNoElement.textContent = companyData.contactNo || 'N/A';
                contactEmailElement.textContent = companyData.email || 'N/A';
            } else {
                console.error('Elements with IDs "contactNo" or "contactEmail" not found');
            }

            // Additional data
            document.getElementById('charges1').textContent = `Charges 1: ${companyData.charges1 || 'N/A'}`;
            document.getElementById('charges2').textContent = `Charges 2: ${companyData.charges2 || 'N/A'}`;
            document.getElementById('paymentQRCharges2').textContent = `Payment QR Charges 2: $${companyData.paymentQRCharges2 || 'N/A'}`;

        } else {
            console.error('Failed to fetch company profile:', data.message || 'Unknown error');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
async function fetchData(userId) {
    try {
        const response = await fetch(`https://quicklone.com/back/checkStatatSecurity/${userId}`);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const data = await response.json();
        console.log(data.Status, "API Status"); // Debugging line

        // Update status and other UI elements based on API response
        updateStatus(data);
        downStatus(data);

        // Check if response indicates successful operation
        if (data.Status) {
            // Display a message about crediting amount
            document.getElementById('statusIcon').innerHTML = `
                <i class="fa fa-check-circle" aria-hidden="true"></i>
                <span id="statusText">Amount has been credited to your bank account with in hour</span>
            `;
        } else {
            // Handle other status codes or messages
            document.getElementById('statusIcon').innerHTML = `
                <i class="fa fa-times-circle" aria-hidden="true"></i>
                <span id="statusText">Failed to credit amount to your bank account with in hour</span>
            `;
        }
    } catch (error) {
        console.error('There was a problem with the fetch operation:', error);
        
        // Update UI for failed fetch
        document.getElementById('statusIcon').innerHTML = `
            <i class="fa fa-times-circle" aria-hidden="true"></i>
            <span id="statusText">An error occurred. Please try again later.</span>
        `;
    }
}

// Example functions for updating status and handling other actions
function updateStatus(data) {
    // Implementation to update status based on data
    // e.g., change status icon or text
}

function downStatus(data) {
    // Implementation to handle any additional status updates or actions
}

function downStatus(data) {
            const downloadButton = document.getElementById('downloadButton');
            console.log(downloadButton, "downloadButton element");
            console.log(data, "data object");

            if (downloadButton) {
                if (data.Status) {
                    downloadButton.disabled = false;
                    console.log("Download button enabled");
                } else {
                    downloadButton.disabled = true;
                    console.log("Download button disabled");
                }
            } else {
                console.error("Download button element not found");
            }
        }

function updateStatus(data) {
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    const header = document.querySelector('.header');
    const downloadButton = document.querySelector('.download-button');

    if (!statusIcon || !statusText || !header || !downloadButton) {
        console.error('One or more DOM elements are missing');
        return;
    }

    // Assuming data.Status contains the status
    const isActive = data.Status === 1; // Adjust based on your actual API response

    statusIcon.querySelector('i').classList.remove('active', 'inactive');
    header.classList.remove('active', 'inactive');

    if (isActive) {
        statusIcon.querySelector('i').classList.add('active');
        statusText.textContent = 'Active';
        header.classList.add('active');
        downloadButton.classList.remove('disabled');
        downloadButton.disabled = false;
    } else {
        statusIcon.querySelector('i').classList.add('inactive');
        statusText.textContent = 'Inactive';
        header.classList.add('inactive');
        downloadButton.classList.add('disabled');
        downloadButton.disabled = true;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('tokenData');
    if (!token) {
        alert('Token is missing. Please login again.');
        return;
    }

    const tokenData = decodeJWT(token);
    const userId = tokenData.user.id;
    console.log("User ID:", userId); // Debugging line

    // Fetch data immediately
    fetchData(userId);
    fetchCompanyProfile(); // Assuming this is defined elsewhere
    fetchUserDetails(); // Assuming this is defined elsewhere

    // Set interval to fetch data every 5 seconds
    setInterval(() => fetchData(userId), 5000);
});

function downloadPDF() {
    const element = document.getElementById('pdfpage');
    const options = {
        margin: 0.5,
        filename: 'application-form.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    html2pdf().set(options).from(element).save();
}

document.addEventListener('DOMContentLoaded', () => {
    const downloadButton = document.getElementById('downloadButton');
    if (downloadButton) {
        downloadButton.addEventListener('click', downloadPDF);
    }
});


</script> 
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

</body>
</html>
